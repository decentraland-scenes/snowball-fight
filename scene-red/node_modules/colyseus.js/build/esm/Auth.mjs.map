{"version":3,"file":"Auth.mjs","sources":["../../src/Auth.ts"],"sourcesContent":["import * as http from \"httpie\";\nimport { getItem, setItem, removeItem } from \"./Storage\";\n\nconst TOKEN_STORAGE = \"colyseus-auth-token\";\n\nexport enum Platform {\n    ios = \"ios\",\n    android = \"android\",\n}\n\nexport interface Device {\n    id: string,\n    platform: Platform\n}\n\nexport interface IStatus {\n    status: boolean;\n}\n\nexport interface IUser {\n    _id: string;\n    username: string;\n    displayName: string;\n    avatarUrl: string;\n\n    isAnonymous: boolean;\n    email: string;\n\n    lang: string;\n    location: string;\n    timezone: string;\n    metadata: any;\n\n    devices: Device[];\n\n    facebookId: string;\n    twitterId: string;\n    googleId: string;\n    gameCenterId: string;\n    steamId: string;\n\n    friendIds: string[];\n    blockedUserIds: string[];\n\n    createdAt: Date;\n    updatedAt: Date;\n}\n\nexport class Auth implements IUser {\n    _id: string = undefined;\n    username: string = undefined;\n    displayName: string = undefined;\n    avatarUrl: string = undefined;\n\n    isAnonymous: boolean = undefined;\n    email: string = undefined;\n\n    lang: string = undefined;\n    location: string = undefined;\n    timezone: string = undefined;\n    metadata: any = undefined;\n\n    devices: Device[] = undefined;\n\n    facebookId: string = undefined;\n    twitterId: string = undefined;\n    googleId: string = undefined;\n    gameCenterId: string = undefined;\n    steamId: string = undefined;\n\n    friendIds: string[] = undefined;\n    blockedUserIds: string[] = undefined;\n\n    createdAt: Date = undefined;\n    updatedAt: Date = undefined;\n\n    // auth token\n    token: string = undefined;\n\n    protected endpoint: string;\n    protected keepOnlineInterval: any;\n\n    constructor(endpoint: string) {\n        this.endpoint = endpoint.replace(\"ws\", \"http\");\n        getItem(TOKEN_STORAGE, (token) => this.token = token);\n    }\n\n    get hasToken() {\n        return !!this.token;\n    }\n\n    async login (options: {\n        accessToken?: string,\n        deviceId?: string,\n        platform?: string,\n        email?: string,\n        password?: string,\n    } = {}) {\n        const queryParams: any = Object.assign({}, options);\n\n        if (this.hasToken) {\n            queryParams.token = this.token;\n        }\n\n        const data = await this.request('post', '/auth', queryParams);\n\n        // set & cache token\n        this.token = data.token;\n        setItem(TOKEN_STORAGE, this.token);\n\n        for (let attr in data) {\n            if (this.hasOwnProperty(attr)) { this[attr] = data[attr]; }\n        }\n\n        this.registerPingService();\n\n        return this;\n    }\n\n    async save() {\n        await this.request('put', '/auth', {}, {\n            username: this.username,\n            displayName: this.displayName,\n            avatarUrl: this.avatarUrl,\n            lang: this.lang,\n            location: this.location,\n            timezone: this.timezone,\n        });\n\n        return this;\n    }\n\n    async getFriends() {\n        return (await this.request('get', '/friends/all')) as IUser[];\n    }\n\n    async getOnlineFriends() {\n        return (await this.request('get', '/friends/online')) as IUser[];\n    }\n\n    async getFriendRequests() {\n        return (await this.request('get', '/friends/requests')) as IUser[];\n    }\n\n    async sendFriendRequest(friendId: string) {\n        return (await this.request('post', '/friends/requests', { userId: friendId })) as IStatus;\n    }\n\n    async acceptFriendRequest(friendId: string) {\n        return (await this.request('put', '/friends/requests', { userId: friendId })) as IStatus;\n    }\n\n    async declineFriendRequest(friendId: string) {\n        return (await this.request('del', '/friends/requests', { userId: friendId })) as IStatus;\n    }\n\n    async blockUser(friendId: string) {\n        return (await this.request('post', '/friends/block', { userId: friendId })) as IStatus;\n    }\n\n    async unblockUser(friendId: string) {\n        return (await this.request('put', '/friends/block', { userId: friendId })) as IStatus;\n    }\n\n    async request(\n        method: 'get' | 'post' | 'put' | 'del',\n        segments: string,\n        query: {[key: string]: number | string} = {},\n        body?: any,\n        headers: {[key: string]: string} = {}\n    ) {\n        headers['Accept'] = 'application/json';\n        if (this.hasToken) { headers['Authorization'] = 'Bearer ' + this.token; }\n\n        const queryParams: string[] = [];\n        for (const name in query) {\n            queryParams.push(`${name}=${query[name]}`);\n        }\n\n        const queryString = (queryParams.length > 0)\n            ? `?${queryParams.join(\"&\")}`\n            : '';\n\n        const opts: Partial<http.Options> = { headers };\n        if (body) { opts.body = body; }\n\n        return (await http[method](`${this.endpoint}${segments}${queryString}`, opts)).data;\n    }\n\n    logout() {\n        this.token = undefined;\n        removeItem(TOKEN_STORAGE);\n        this.unregisterPingService();\n    }\n\n    registerPingService(timeout: number = 15000) {\n        this.unregisterPingService();\n\n        this.keepOnlineInterval = setInterval(() => this.request('get', '/auth'), timeout);\n    }\n\n    unregisterPingService() {\n        clearInterval(this.keepOnlineInterval);\n    }\n\n}\n"],"names":[],"mappings":";;;;AAGA,MAAM,aAAa,GAAG,qBAAqB,CAAC;IAEhC;AAAZ,WAAY,QAAQ;IAChB,uBAAW,CAAA;IACX,+BAAmB,CAAA;AACvB,CAAC,EAHW,QAAQ,KAAR,QAAQ,QAGnB;MAwCY,IAAI;IACb,GAAG,GAAW,SAAS,CAAC;IACxB,QAAQ,GAAW,SAAS,CAAC;IAC7B,WAAW,GAAW,SAAS,CAAC;IAChC,SAAS,GAAW,SAAS,CAAC;IAE9B,WAAW,GAAY,SAAS,CAAC;IACjC,KAAK,GAAW,SAAS,CAAC;IAE1B,IAAI,GAAW,SAAS,CAAC;IACzB,QAAQ,GAAW,SAAS,CAAC;IAC7B,QAAQ,GAAW,SAAS,CAAC;IAC7B,QAAQ,GAAQ,SAAS,CAAC;IAE1B,OAAO,GAAa,SAAS,CAAC;IAE9B,UAAU,GAAW,SAAS,CAAC;IAC/B,SAAS,GAAW,SAAS,CAAC;IAC9B,QAAQ,GAAW,SAAS,CAAC;IAC7B,YAAY,GAAW,SAAS,CAAC;IACjC,OAAO,GAAW,SAAS,CAAC;IAE5B,SAAS,GAAa,SAAS,CAAC;IAChC,cAAc,GAAa,SAAS,CAAC;IAErC,SAAS,GAAS,SAAS,CAAC;IAC5B,SAAS,GAAS,SAAS,CAAC;;IAG5B,KAAK,GAAW,SAAS,CAAC;IAEhB,QAAQ,CAAS;IACjB,kBAAkB,CAAM;IAElC,YAAY,QAAgB;QACxB,IAAI,CAAC,QAAQ,GAAG,QAAQ,CAAC,OAAO,CAAC,IAAI,EAAE,MAAM,CAAC,CAAC;QAC/C,OAAO,CAAC,aAAa,EAAE,CAAC,KAAK,KAAK,IAAI,CAAC,KAAK,GAAG,KAAK,CAAC,CAAC;KACzD;IAED,IAAI,QAAQ;QACR,OAAO,CAAC,CAAC,IAAI,CAAC,KAAK,CAAC;KACvB;IAED,MAAM,KAAK,CAAE,UAMT,EAAE;QACF,MAAM,WAAW,GAAQ,MAAM,CAAC,MAAM,CAAC,EAAE,EAAE,OAAO,CAAC,CAAC;QAEpD,IAAI,IAAI,CAAC,QAAQ,EAAE;YACf,WAAW,CAAC,KAAK,GAAG,IAAI,CAAC,KAAK,CAAC;SAClC;QAED,MAAM,IAAI,GAAG,MAAM,IAAI,CAAC,OAAO,CAAC,MAAM,EAAE,OAAO,EAAE,WAAW,CAAC,CAAC;;QAG9D,IAAI,CAAC,KAAK,GAAG,IAAI,CAAC,KAAK,CAAC;QACxB,OAAO,CAAC,aAAa,EAAE,IAAI,CAAC,KAAK,CAAC,CAAC;QAEnC,KAAK,IAAI,IAAI,IAAI,IAAI,EAAE;YACnB,IAAI,IAAI,CAAC,cAAc,CAAC,IAAI,CAAC,EAAE;gBAAE,IAAI,CAAC,IAAI,CAAC,GAAG,IAAI,CAAC,IAAI,CAAC,CAAC;aAAE;SAC9D;QAED,IAAI,CAAC,mBAAmB,EAAE,CAAC;QAE3B,OAAO,IAAI,CAAC;KACf;IAED,MAAM,IAAI;QACN,MAAM,IAAI,CAAC,OAAO,CAAC,KAAK,EAAE,OAAO,EAAE,EAAE,EAAE;YACnC,QAAQ,EAAE,IAAI,CAAC,QAAQ;YACvB,WAAW,EAAE,IAAI,CAAC,WAAW;YAC7B,SAAS,EAAE,IAAI,CAAC,SAAS;YACzB,IAAI,EAAE,IAAI,CAAC,IAAI;YACf,QAAQ,EAAE,IAAI,CAAC,QAAQ;YACvB,QAAQ,EAAE,IAAI,CAAC,QAAQ;SAC1B,CAAC,CAAC;QAEH,OAAO,IAAI,CAAC;KACf;IAED,MAAM,UAAU;QACZ,QAAQ,MAAM,IAAI,CAAC,OAAO,CAAC,KAAK,EAAE,cAAc,CAAC,EAAa;KACjE;IAED,MAAM,gBAAgB;QAClB,QAAQ,MAAM,IAAI,CAAC,OAAO,CAAC,KAAK,EAAE,iBAAiB,CAAC,EAAa;KACpE;IAED,MAAM,iBAAiB;QACnB,QAAQ,MAAM,IAAI,CAAC,OAAO,CAAC,KAAK,EAAE,mBAAmB,CAAC,EAAa;KACtE;IAED,MAAM,iBAAiB,CAAC,QAAgB;QACpC,QAAQ,MAAM,IAAI,CAAC,OAAO,CAAC,MAAM,EAAE,mBAAmB,EAAE,EAAE,MAAM,EAAE,QAAQ,EAAE,CAAC,EAAa;KAC7F;IAED,MAAM,mBAAmB,CAAC,QAAgB;QACtC,QAAQ,MAAM,IAAI,CAAC,OAAO,CAAC,KAAK,EAAE,mBAAmB,EAAE,EAAE,MAAM,EAAE,QAAQ,EAAE,CAAC,EAAa;KAC5F;IAED,MAAM,oBAAoB,CAAC,QAAgB;QACvC,QAAQ,MAAM,IAAI,CAAC,OAAO,CAAC,KAAK,EAAE,mBAAmB,EAAE,EAAE,MAAM,EAAE,QAAQ,EAAE,CAAC,EAAa;KAC5F;IAED,MAAM,SAAS,CAAC,QAAgB;QAC5B,QAAQ,MAAM,IAAI,CAAC,OAAO,CAAC,MAAM,EAAE,gBAAgB,EAAE,EAAE,MAAM,EAAE,QAAQ,EAAE,CAAC,EAAa;KAC1F;IAED,MAAM,WAAW,CAAC,QAAgB;QAC9B,QAAQ,MAAM,IAAI,CAAC,OAAO,CAAC,KAAK,EAAE,gBAAgB,EAAE,EAAE,MAAM,EAAE,QAAQ,EAAE,CAAC,EAAa;KACzF;IAED,MAAM,OAAO,CACT,MAAsC,EACtC,QAAgB,EAChB,QAA0C,EAAE,EAC5C,IAAU,EACV,UAAmC,EAAE;QAErC,OAAO,CAAC,QAAQ,CAAC,GAAG,kBAAkB,CAAC;QACvC,IAAI,IAAI,CAAC,QAAQ,EAAE;YAAE,OAAO,CAAC,eAAe,CAAC,GAAG,SAAS,GAAG,IAAI,CAAC,KAAK,CAAC;SAAE;QAEzE,MAAM,WAAW,GAAa,EAAE,CAAC;QACjC,KAAK,MAAM,IAAI,IAAI,KAAK,EAAE;YACtB,WAAW,CAAC,IAAI,CAAC,GAAG,IAAI,IAAI,KAAK,CAAC,IAAI,CAAC,EAAE,CAAC,CAAC;SAC9C;QAED,MAAM,WAAW,GAAG,CAAC,WAAW,CAAC,MAAM,GAAG,CAAC;cACrC,IAAI,WAAW,CAAC,IAAI,CAAC,GAAG,CAAC,EAAE;cAC3B,EAAE,CAAC;QAET,MAAM,IAAI,GAA0B,EAAE,OAAO,EAAE,CAAC;QAChD,IAAI,IAAI,EAAE;YAAE,IAAI,CAAC,IAAI,GAAG,IAAI,CAAC;SAAE;QAE/B,OAAO,CAAC,MAAM,IAAI,CAAC,MAAM,CAAC,CAAC,GAAG,IAAI,CAAC,QAAQ,GAAG,QAAQ,GAAG,WAAW,EAAE,EAAE,IAAI,CAAC,EAAE,IAAI,CAAC;KACvF;IAED,MAAM;QACF,IAAI,CAAC,KAAK,GAAG,SAAS,CAAC;QACvB,UAAU,CAAC,aAAa,CAAC,CAAC;QAC1B,IAAI,CAAC,qBAAqB,EAAE,CAAC;KAChC;IAED,mBAAmB,CAAC,UAAkB,KAAK;QACvC,IAAI,CAAC,qBAAqB,EAAE,CAAC;QAE7B,IAAI,CAAC,kBAAkB,GAAG,WAAW,CAAC,MAAM,IAAI,CAAC,OAAO,CAAC,KAAK,EAAE,OAAO,CAAC,EAAE,OAAO,CAAC,CAAC;KACtF;IAED,qBAAqB;QACjB,aAAa,CAAC,IAAI,CAAC,kBAAkB,CAAC,CAAC;KAC1C;;;;;"}